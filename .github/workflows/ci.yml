name: CI

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

permissions:
    contents: read
    pull-requests: write

jobs:
    quality-checks:
        name: Quality Checks
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Lint code
              run: bun run lint:check

            - name: Check formatting
              run: bun run format:check

            - name: Type check
              run: bun run type-check

    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run unit tests
              run: bun run test:unit

    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Install Playwright browsers
              run: bunx playwright install --with-deps

            - name: Start server
              run: bun run server &
              env:
                  PORT: 4000

            - name: Wait for server
              run: npx wait-on http://localhost:4000/api/health --timeout 30000

            - name: Start client
              run: bun run client &
              env:
                  VITE_API_URL: http://localhost:4000

            - name: Wait for client
              run: npx wait-on http://localhost:3000 --timeout 30000

            - name: Run E2E tests
              run: bun run test:e2e:no-server

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: playwright-report
                  path: tests/e2e/playwright-report/
                  retention-days: 7

    api-tests:
        name: API Tests
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Start server
              run: bun run server &
              env:
                  PORT: 4000

            - name: Wait for server
              run: npx wait-on http://localhost:4000/api/health --timeout 30000

            - name: Run API tests
              run: bun run test:api

    build:
        name: Build Check
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build client
              run: bun --cwd packages/client run build

            - name: Check bundle size
              run: |
                  CLIENT_SIZE=$(du -sb packages/client/dist 2>/dev/null | cut -f1 || echo "0")
                  MAX_SIZE=524288  # 512KB
                  echo "Client bundle size: $CLIENT_SIZE bytes"
                  if [ $CLIENT_SIZE -gt $MAX_SIZE ]; then
                    echo "❌ Client bundle exceeds $MAX_SIZE bytes"
                    exit 1
                  fi
                  echo "✅ Client bundle size OK"

    storybook-build:
        name: Storybook Build
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build Storybook
              run: bun --cwd packages/client run build-storybook

    security:
        name: Security Audit
        runs-on: ubuntu-latest
        timeout-minutes: 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Security audit
              run: bun audit || echo "⚠️ Security vulnerabilities found - review required"

    all-checks:
        name: All Checks Passed
        runs-on: ubuntu-latest
        needs:
            [
                quality-checks,
                unit-tests,
                e2e-tests,
                api-tests,
                build,
                storybook-build,
                security,
            ]
        if: always()

        steps:
            - name: Check all jobs
              run: |
                  if [ "${{ needs.quality-checks.result }}" != "success" ] || \
                     [ "${{ needs.unit-tests.result }}" != "success" ] || \
                     [ "${{ needs.e2e-tests.result }}" != "success" ] || \
                     [ "${{ needs.api-tests.result }}" != "success" ] || \
                     [ "${{ needs.build.result }}" != "success" ] || \
                     [ "${{ needs.storybook-build.result }}" != "success" ]; then
                    echo "❌ Some checks failed"
                    exit 1
                  fi
                  echo "✅ All checks passed!"
